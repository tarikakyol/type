<!DOCTYPE html>
<!--[if lt IE 10]><html class="lt-ie10"><![endif]-->
<!--[if gte IE 10]><!--> <html lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10.0, minimum-scale=1, user-scalable=no">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="width">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>SPLASH Chat</title>
</head>
<style type="text/css">
body{
    font-family: 'Menlo Regular', 'Lucida Console', Monaco, monospace, 'Courier New', Fixed;
    font-size: 12px;
    background: black;
    color: white;
}
input[type=text]{
    color:white;
    background: black;
    border: none;
    width: calc(100% - 20px);
    outline: none;
    font-size: 13px;
}
.logo{
    font-family: 'Arial Black';
    font-size: 40px;
}
.warning{
    color: red;
}
.green{
    color: #2ecc71;
}
.white{
    color: white;
}
.orange{
    color: #e67e22;
}
.cline{
    padding: 0;
    margin: 0;
}
.hr{
    border-top: dashed 1px;
    padding-bottom: 5px;
}
.logo span{
    letter-spacing: -21px;
    transition: all 600ms linear;
}

</style>
<body>
<div class="logo">
    <span style="color:#32CCFE">S</span>
    <span style="color:#5D7BB9">P</span>
    <span style="color:#DD77D3">L</span>
    <span style="color:#2ecc71">A</span>
    <span style="color:#e67e22">S</span>
    <span style="color:#019fde">H</span>
</div>
<div class="hello"></div>
<div class="hr"></div>
><input type="text"></input>
<div class="chat"></div>

</body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script>
var chat=[], colors = [], channel, ws;
var post = function(){
    var v = $('input').val();
    if(v.length < 1) return false;
    var words = v.split(" ");
    if(words[0] == "name"){
        setNickName(words[1]);
        $('.chat').prepend("<p class='cline warning'>Your nick is now: "+words[1]+"</p>");
        $('input').val("");
        setHeader();
        return;
    }else if(words[0] == "color"){
        var color = words[1];
        color = color.replace('#','hash');
        $.get( "/changeColor?nick="+getNickName()+"&color="+color, function(data) {
            $('.chat').prepend("<p class='cline warning'>Your color is now: "+words[1]+"</p>");
            $('input').val("");
        });
        return;
    }
    $.get( "/put?nick="+getNickName()+"&text="+v+"&channel="+channel, function(data) {
        $('input').val("");
        print();
    });
}
var print = function(){
    $('.chat').html("");
    for(i=0;i<chat.length;i++){
        $('.chat').prepend("<p class='cline' style='color:"+chat[i][2]+"'>"+chat[i][0]+": "+chat[i][1])+"</p>";
    }
}
var setHeader = function(){
    $(".hello").html("<span class='orange'>HELLO "+getNickName()+"</span><p class='green'>Welcome to Splash Chat app. It's so simple!</p><p class='white'>For now you can only -obviously- chat, use 'name' and 'color' commands to change your username and color! Yes this is a feature :)<p>");
}
var setNickName = function(nick){
    if(nick){
        localStorage["nick"] = nick;
    }else{
        if(typeof localStorage["nick"] == "undefined") localStorage["nick"] = "user_"+Date.now();
    }
}
var getNickName = function(){
    return localStorage["nick"];
}
var setLogo = function(){
    setInterval(function(){
        $('.logo span').each(function(){$(this).css(
            {
                'color':'#'+Math.floor(Math.random()*16777215).toString(16),
                'letter-spacing': -(Math.floor(Math.random() * 30) + 15),
                'opacity': (Math.random() * 1)
            })
        });
    }, 5000);
}
var setupWebSocket = function(){
    var host = location.origin.replace(/^http/, 'ws');
    ws = new WebSocket(host);
    setInterval(function(){
        ws.send(channel);
    }, 1000);
    ws.onmessage = function (event) {
        chat = JSON.parse(event.data);
        print();
    };
    ws.onclose = function (){
        console.log("WebSocket closed, restarting..");
        init();
    };
}
var setChannel = function(){
    if(getUrlParam('channel')){
        channel = getUrlParam('channel');
    }else{
        channel = "default";
    }
}
var getUrlParam = function (sParam){
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1];
        }
    }
}
var init = function(){    
    // set channel
    setChannel();
    // Nickname and header text setter
    setNickName();
    setHeader();
    // LOGO animation
    setLogo();
    // handling websocket
    setupWebSocket();
}
$( document ).ready(function() {
    //initialize
    init();

    // set Listeners
    $("input").focus();
    $('html').click(function(){
        $('input').focus();
    })
    $('input').keyup(function(e){
        if(e.keyCode == 13){
            post();
        }
    });
});
</script>
</html>
